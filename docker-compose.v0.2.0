# Project: confAdogpt  Component: compose  Version: v0.3.0
services:
  api:
    build: ./server
    container_name: confAdogpt_api
    environment:
      - DATA_ROOT=/data
      - INDEX_PATH=/index/docs.db
      - INDEX_ROOT=${INDEX_ROOT:-/index}
      - CHUNK_SIZE_BYTES=${CHUNK_SIZE_BYTES:-90000}
      - AUTO_INGEST=${AUTO_INGEST:-0}
      - ALLOW_ORIGINS=${ALLOW_ORIGINS:-*}
      - ADO_ROOT=${ADO_ROOT:-/ado}
      # --- RAG / embeddings ---
      - ALLOW_REMOTE_EMBEDDINGS=${ALLOW_REMOTE_EMBEDDINGS:-0}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - EMBED_DIM=${EMBED_DIM:-1536}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
      - EMBED_MAX_TOKENS_PER_REQ=${EMBED_MAX_TOKENS_PER_REQ:-250000}
      - EMBED_MAX_TOKENS_PER_ITEM=${EMBED_MAX_TOKENS_PER_ITEM:-8000}
      - EMBED_TPM_LIMIT=${EMBED_TPM_LIMIT:-1000000}
      - EMBED_RPM_LIMIT=${EMBED_RPM_LIMIT:-5000}
      - EMBED_HEADROOM=${EMBED_HEADROOM:-0.90}
      - EMBED_BATCH_SLEEP_MS=${EMBED_BATCH_SLEEP_MS:-0}
      - EMBED_MAX_RETRIES=${EMBED_MAX_RETRIES:-6}
      - EMBED_BACKOFF_MIN_MS=${EMBED_BACKOFF_MIN_MS:-500}
      - EMBED_BACKOFF_MAX_MS=${EMBED_BACKOFF_MAX_MS:-8000}
      # --- Observability (optional) ---
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      # --- Code features (optional) ---
      - ENABLE_TREE_SITTER=${ENABLE_TREE_SITTER:-0}
      - CODE_ROOT=${CODE_ROOT}
      - CODE_URL_TEMPLATE=${CODE_URL_TEMPLATE}
      # --- OCR policy defaults (Round 1 typical) ---
      - OCR_ENABLED=${OCR_ENABLED:-0}
      - OCR_PDF_IF_EMPTY=${OCR_PDF_IF_EMPTY:-0}
      - OCR_IMAGES=${OCR_IMAGES:-0}
      - OCR_DPI=${OCR_DPI:-50}
    ports:
      - "9001:8000"
    volumes:
      - /mnt/disks/data/confgpt_action_server_docker_compose/export_data:/data:ro
      - ./index:/index
      - /mnt/disks/data/fetch_ado_items/.ado_cache/8127d161517e897b:/ado:ro
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/v1/health"]
      interval: 10s
      timeout: 3s
      retries: 10
    # Resource governance for API
    deploy:
      resources:
        limits:
          cpus: "0.50"
          memory: 2g
        reservations:
          cpus: "0.25"
          memory: 1g
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    logging:
      driver: json-file
      options:
        max-size: "20m"
        max-file: "5"

  # One-off full export indexer (unchanged command; no healthcheck)
  ingest:
    build: ./server
    container_name: confAdogpt_ingest
    command: ["python", "-m", "app.indexer", "--data-root", "/data", "--index-path", "/index/docs.db", "--ado-root", "${ADO_ROOT:-/ado}"]
    environment:
      - DATA_ROOT=/data
      - INDEX_PATH=/index/docs.db
      - ADO_ROOT=${ADO_ROOT:-/ado}
      - INDEX_ROOT=${INDEX_ROOT:-/index}
      # Pass-through (not used by indexer)
      - ALLOW_REMOTE_EMBEDDINGS=${ALLOW_REMOTE_EMBEDDINGS:-0}
      - EMBED_DIM=${EMBED_DIM:-1536}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
      - EMBED_MAX_TOKENS_PER_REQ=${EMBED_MAX_TOKENS_PER_REQ:-250000}
      - EMBED_MAX_TOKENS_PER_ITEM=${EMBED_MAX_TOKENS_PER_ITEM:-8000}
      - EMBED_TPM_LIMIT=${EMBED_TPM_LIMIT:-1000000}
      - EMBED_RPM_LIMIT=${EMBED_RPM_LIMIT:-5000}
      - EMBED_HEADROOM=${EMBED_HEADROOM:-0.90}
      - EMBED_BATCH_SLEEP_MS=${EMBED_BATCH_SLEEP_MS:-0}
      - EMBED_MAX_RETRIES=${EMBED_MAX_RETRIES:-6}
      - EMBED_BACKOFF_MIN_MS=${EMBED_BACKOFF_MIN_MS:-500}
      - EMBED_BACKOFF_MAX_MS=${EMBED_BACKOFF_MAX_MS:-8000}
    volumes:
      - /mnt/disks/data/confgpt_action_server_docker_compose/export_data:/data:ro
      - ./index:/index
      - /mnt/disks/data/fetch_ado_items/.ado_cache/8127d161517e897b:/ado:ro
    profiles: ["tools"]
    # Resource governance for indexer job
    deploy:
      resources:
        limits:
          cpus: "1.25"
          memory: 6g
        reservations:
          cpus: "0.75"
          memory: 3g
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    logging:
      driver: json-file
      options:
        max-size: "20m"
        max-file: "5"

  # Attachments ingestor as a separate jobbed service (no healthcheck)
  att_ingest:
    build: ./server
    container_name: confAdogpt_att_ingest
    command: ["python", "-u", "-m", "app.attachments_ingest", "--spaces", "ALL", "--batch", "300"]
    environment:
      - DATA_ROOT=/data
      - INDEX_PATH=/index/docs.db
      - INDEX_ROOT=${INDEX_ROOT:-/index}
      - ADO_ROOT=${ADO_ROOT:-/ado}
      # OCR policy (adjust per round)
      - OCR_ENABLED=${OCR_ENABLED:-0}
      - OCR_PDF_IF_EMPTY=${OCR_PDF_IF_EMPTY:-0}
      - OCR_IMAGES=${OCR_IMAGES:-0}
      - OCR_DPI=${OCR_DPI:-50}
      # Embedding limiter envs are read by app.embeddings (if used)
      - ALLOW_REMOTE_EMBEDDINGS=${ALLOW_REMOTE_EMBEDDINGS:-0}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - EMBED_DIM=${EMBED_DIM:-1536}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
      - EMBED_MAX_TOKENS_PER_REQ=${EMBED_MAX_TOKENS_PER_REQ:-250000}
      - EMBED_MAX_TOKENS_PER_ITEM=${EMBED_MAX_TOKENS_PER_ITEM:-8000}
      - EMBED_TPM_LIMIT=${EMBED_TPM_LIMIT:-1000000}
      - EMBED_RPM_LIMIT=${EMBED_RPM_LIMIT:-5000}
      - EMBED_HEADROOM=${EMBED_HEADROOM:-0.90}
      - EMBED_BATCH_SLEEP_MS=${EMBED_BATCH_SLEEP_MS:-0}
      - EMBED_MAX_RETRIES=${EMBED_MAX_RETRIES:-6}
      - EMBED_BACKOFF_MIN_MS=${EMBED_BACKOFF_MIN_MS:-500}
      - EMBED_BACKOFF_MAX_MS=${EMBED_BACKOFF_MAX_MS:-8000}
      # Logs
      - ATT_LOG_PATH=/index/attachments_ingest.log
    volumes:
      - /mnt/disks/data/confgpt_action_server_docker_compose/export_data:/data:ro
      - ./index:/index
      - /mnt/disks/data/fetch_ado_items/.ado_cache/8127d161517e897b:/ado:ro
    profiles: ["tools"]
    # Resource governance for attachments OCR+embed job
    deploy:
      resources:
        limits:
          cpus: "1.25"
          memory: 6g
        reservations:
          cpus: "0.75"
          memory: 3g
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    logging:
      driver: json-file
      options:
        max-size: "20m"
        max-file: "5"
